'use strict';

/**
 * This component manages the intro/win/lose monologues.  It plays sound and shows images/text
 * based on the content of the json file it is told to load.
 */
Plan10.Component.Monologue = function(gameObject, component) {

    //public, to be set in prefab definitions, look at 'assets/monologue_example.json' for example format
    //component.dataFile = null;
    
    //some private state things
    var timeStarted = null;
    var started = false;
    var finished = false;
    
    var canvas_plugin_lastcall = 0; //tell canvas plugin to clean up before loading next scene
    var canvas_plugin_finished = 0; //when canvas is finished, load next scene
    var loop_breaker           = 0; 
    
    var jsonDataArray = [];
    var monoArray = [];    //eventually use 1 array instead of 3
    var monoLast = 2;     //list of assets - 1
    var monoIndex = (-1);  //init to -1 so that it will increment to start of array upon first loop
    var imgChanged = 0;
    
    var frameDelay = null;    
    var lastTimeDrawn = 0;
    
    var theater_img = null;
    
    var audio;
    
    

    //load a bunch of stuff and start
    component.$on('engine.create', function() {
        gameObject.disable();
        audio = gameObject.getComponent('audioEmitter');

       // gameObject.engine.loadAsset(audioPaths[0], function() {
           //nothing to do!
        //});
        
        
        gameObject.engine.loadAsset(component.dataFile, function(json_array) {                
            jsonDataArray = JSON.parse(json_array);
            gameObject.enable();
        
        /*
        for (var i = 0; i < jsonDataArray.length; i++)
         {
         console.log("jsonDataArray time" + jsonDataArray.frames[i].time);
         }
        
        
        for i = 0 to jasonDataArray.length {
        loadAsset(jasonDataArray[i].image
        loadAsset(jasonDataArray[i].sound
        jasonDataArray[i]
        
        */    
        
        });
                
    
    });

    
    //just keep track of state  
    component.$on('engine.update', function(deltaTime) {
        //if starting, set framedelay to length of first frame
          console.log("json array length: " + jsonDataArray.length);
     //   console.log("jsondata: " + jsonDataArray.frames[0].image + " " + jsonDataArray.frames[0].soundfile + " " + jsonDataArray.frames[0].time); 
     //   console.log("more jsondata: " + jsonDataArray.frames[1].image + " " + jsonDataArray.frames[1].soundfile + " " + jsonDataArray.frames[1].time);
        if (started === false) { 
            started = true;
            frameDelay = ((monoArray.frames[0].time)*1000);
        } 
        
  
        //either here, or in the `canvas2d.draw` section, check to figure
        //out when the monologue has finished and set "finished" to true
            if (lastTimeDrawn + frameDelay <= gameObject.engine.time) {       
                lastTimeDrawn = gameObject.engine.time;
                
                //log some stuff
                console.log("monoindex: " + monoIndex);
                console.log("canvas_plugin_lastcall: " + canvas_plugin_lastcall);
                console.log("canvas_plugin_finished: " + canvas_plugin_finished);

            if ( (!(canvas_plugin_finished)) && (!(canvas_plugin_lastcall)) ){     
                
                //use monoIndex to loop through all the assets and keep them in sync.
                if (monoIndex === (monoLast)) { canvas_plugin_lastcall = 1; loop_breaker = 1; }
                if (monoIndex < monoLast) {  monoIndex++; }  
                
                
                //set frameDelay to length of next part of monologue
                frameDelay = ((monoArray[monoIndex]) * 1000); 
                
                //start playing next monologue audio, canvas will draw next image in a second
                // added "loop_breaker" because the game still plays the audio file even though I can tell Canvas to stop drawing
                // this leads to the canvas clearing, but the final audio playing 1 more time before the next scene loads
                // not sure why
                  if (!(loop_breaker)) { audio.playOnce(monoArray.frames[monoIndex].soundfile);}
            
            }
            
            else {
            console.log("I think I got it");
           // gameObject.engine.loadScene('plan10.main', function() {
           //         gameObject.engine.run();
           // });
             gameObject.emit('plan10.splash_screen');
            }
        } 
   

    });
    
    //actually draw the monologue images/text
    component.$on('canvas2d.draw', function(context) {
         context.drawImage(monoArray.frames[monoIndex].image,0,0,800,600);
         frameDelay = (monoArray.frames[monoIndex].time * 1000);               
         
         if (canvas_plugin_lastcall) {
              canvas_plugin_finished = 1;
              context.clearRect(0, 0, 800, 600);
         }
    
         
    });
};
Plan10.Component.Monologue.alias = "plan10.monologue";
Plan10.Component.Monologue.requires = [
//    'audioListener'
      'audioEmitter'
];
